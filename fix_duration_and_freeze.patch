*** Begin Patch
*** Update File: index.php
@@ function concatenateTsFiles($tsFiles, $outputFile) {
-    $tsList = implode('|', $tsFiles);
-    if ($backgroundAudio) {
-        $cmd = sprintf(
-            'ffmpeg -i "concat:%s" -stream_loop -1 -i %s -filter_complex "[0:a][1:a]amix=inputs=2:duration=first:dropout_transition=3[aout]" -map 0:v -map "[aout]" -c:v libx264 -c:a aac -shortest %s',
-            $tsList,
-            escapeshellarg($backgroundAudio),
-            escapeshellarg($outputFile)
-        );
-    } else {
-        $cmd = sprintf(
-            'ffmpeg -i "concat:%s" -c copy -bsf:a aac_adtstoasc %s',
-            $tsList,
-            escapeshellarg($outputFile)
-        );
-    }
+    global $targetDuration;
+    // Genera un file lista per concat demuxer
+    $listFile = tempnam(sys_get_temp_dir(), 'concat_') . '.txt';
+    $fp = fopen($listFile, 'w');
+    foreach ($tsFiles as $ts) {
+        fwrite($fp, "file '" . str_replace("'", "'\\\\''", $ts) . "'\n");
+    }
+    fclose($fp);
+
+    // Applica durata massima se specificata
+    $durationOption = (!empty($targetDuration) ? ' -t ' . intval($targetDuration) : '');
+
+    if ($backgroundAudio) {
+        $cmd = sprintf(
+            'ffmpeg -f concat -safe 0 -i %s -stream_loop -1 -i %s -filter_complex "[0:a][1:a]amix=inputs=2:duration=first:dropout_transition=3[aout]" -map 0:v -map "[aout]" -c:v libx264 -c:a aac%s %s',
+            escapeshellarg($listFile),
+            escapeshellarg($backgroundAudio),
+            $durationOption,
+            escapeshellarg($outputFile)
+        );
+    } else {
+        $cmd = sprintf(
+            'ffmpeg -f concat -safe 0 -i %s -c:v libx264 -c:a aac%s %s',
+            escapeshellarg($listFile),
+            $durationOption,
+            escapeshellarg($outputFile)
+        );
+    }
+
+    shell_exec($cmd);
+    @unlink($listFile);
*** End Patch
